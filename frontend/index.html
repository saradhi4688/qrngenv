<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantum RNG v2.0 Alpha</title>

  <!-- Tailwind + Chart.js + GSAP -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            quantum: { primary: '#6366f1', green: '#10b981', purple: '#a855f7' }
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg,#111827 0%,#1f2937 100%);
      min-height: 100vh; color: #f3f4f6; transition: background .4s, color .4s;
    }
    .glass-card {
      background: rgba(255,255,255,0.06); backdrop-filter: blur(8px);
      border-radius: 14px; border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 6px 26px rgba(0,0,0,0.3);
    }
    .btn-primary { background: linear-gradient(135deg,#6366f1,#4f46e5); color: #fff; padding: .6rem 1rem; border-radius: 10px; font-weight:600; }
    .btn-secondary { background: rgba(255,255,255,0.04); color: #fff; padding: .45rem .75rem; border-radius: 10px; }
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 75%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius: 8px; }
    @keyframes shimmer { 0%{background-position:-400px 0;}100%{background-position:400px 0;} }
    .particle { position: absolute; width:6px; height:6px; background: rgba(99,102,241,0.75); border-radius:50%; animation: float 4s infinite ease-in-out; pointer-events: none; }
    @keyframes float { 0%{transform: translateY(0)}50%{transform: translateY(-18px)}100%{transform: translateY(0)} }
    .toast { position: fixed; top: 1rem; right: 1rem; z-index: 9999; padding:.6rem 1rem; border-radius:8px; color:white; box-shadow:0 8px 20px rgba(0,0,0,0.35); }
    .toast.info { background: rgba(59,130,246,0.95); } .toast.success { background: rgba(16,185,129,0.95); } .toast.error { background: rgba(239,68,68,0.95); }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid rgba(255,255,255,0.04); padding: 6px 8px; text-align:center; }
  </style>
</head>

<body class="transition-colors duration-300">

  <!-- Navbar -->
  <nav class="fixed top-0 left-0 right-0 bg-black/30 backdrop-blur z-50 px-6 py-3 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <h1 class="text-lg font-bold text-blue-300">âš› Quantum RNG</h1>
      <span class="text-sm text-gray-300">v2.0-alpha</span>
    </div>

    <div class="flex items-center gap-3">
      <button id="themeToggle" class="px-3 py-1 rounded-lg bg-gray-700 text-sm">ðŸŒ—</button>
      <select id="accentPicker" class="bg-gray-700 text-sm rounded-lg px-2 py-1 text-gray-200">
        <option value="blue">Blue</option>
        <option value="green">Green</option>
        <option value="purple">Purple</option>
      </select>
      <button id="pingBtn" class="btn-secondary">Ping</button>
    </div>
  </nav>

  <main class="pt-20 container mx-auto px-4 pb-12 space-y-6">

    <!-- Onboarding (first-visit) -->
    <div id="onboarding" class="glass-card p-3 text-sm text-center hidden">ðŸ‘‹ Welcome! Select bits & samples then click <strong class="text-blue-300">Generate</strong>.</div>

    <!-- Controls -->
    <section class="glass-card p-6 max-w-4xl mx-auto">
      <h2 class="text-xl font-semibold text-blue-300 mb-4">Generate Random Numbers</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="text-sm text-gray-300 block mb-1">Number of Bits</label>
          <select id="numBits" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-white">
            <option value="4">4 bits (0-15)</option>
            <option value="8" selected>8 bits (0-255)</option>
            <option value="12">12 bits (0-4095)</option>
            <option value="16">16 bits (0-65535)</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-gray-300 block mb-1">Quantity</label>
          <input id="numSamples" type="number" value="16" min="1" max="5000" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-white" />
        </div>

        <div class="flex gap-2">
          <button id="generateBtn" class="btn-primary flex-1">ðŸ”® Generate</button>
          <button id="copyBtn" class="btn-secondary">Copy</button>
          <button id="downloadJson" class="btn-secondary">JSON</button>
          <button id="downloadCsv" class="btn-secondary">CSV</button>
        </div>
      </div>

      <p id="errorBox" class="text-red-400 mt-3 text-sm"></p>
    </section>

    <!-- Results -->
    <section class="glass-card p-6 max-w-4xl mx-auto">
      <div class="flex justify-between items-start">
        <h2 class="text-xl font-semibold text-green-300">Results</h2>
        <div id="sourceIndicator" class="source-badge source-anu opacity-0 transition-opacity duration-300">ANU Quantum Source</div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-3 bg-gray-900/30 rounded-lg text-center">
          <div class="text-lg font-bold" id="meanValue">â€”</div>
          <div class="text-xs text-gray-400">Mean</div>
        </div>
        <div class="p-3 bg-gray-900/30 rounded-lg text-center">
          <div class="text-lg font-bold" id="stdValue">â€”</div>
          <div class="text-xs text-gray-400">Std Dev</div>
        </div>
        <div class="p-3 bg-gray-900/30 rounded-lg text-center">
          <div class="text-lg font-bold" id="minValue">â€”</div>
          <div class="text-xs text-gray-400">Minimum</div>
        </div>
        <div class="p-3 bg-gray-900/30 rounded-lg text-center">
          <div class="text-lg font-bold" id="maxValue">â€”</div>
          <div class="text-xs text-gray-400">Maximum</div>
        </div>
      </div>

      <div class="mt-4 flex gap-6 items-center text-sm text-gray-300">
        <div>Entropy: <span id="entropyValue">â€”</span></div>
        <div>Version: <span id="metaVersion">â€”</span></div>
        <div>Timestamp: <span id="metaTime">â€”</span></div>
      </div>

      <div class="result-container mt-6" id="resultDisplay">
        <div class="text-center py-8 text-gray-400">
          <p>Ready to generate quantum random numbers</p>
        </div>
      </div>
    </section>

    <!-- Chart -->
    <section class="glass-card p-6 max-w-4xl mx-auto">
      <h2 class="text-xl font-semibold text-blue-300">Distribution Graph</h2>
      <div style="height:360px;" class="mt-4">
        <canvas id="distributionChart" height="360"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="glass-card p-6 max-w-4xl mx-auto">
      <h2 class="text-xl font-semibold text-blue-300">Generated Numbers (table)</h2>
      <div class="overflow-auto mt-4">
        <table class="w-full text-sm">
          <thead class="bg-gray-800/40">
            <tr><th class="p-2">#</th><th class="p-2">Decimal</th><th class="p-2">Binary</th></tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-800/30"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Particles container -->
  <div class="fixed inset-0 pointer-events-none"></div>

  <!-- Frontend JS: synced & robust -->
  <script>
/* ========== CONFIG ========== */
/* Change this to your backend host if needed (e.g. 'http://localhost:5000') */
const API_BASE_URL = 'https://qrngenvbackend.onrender.com'; // <- change to your running backend if different

let distributionChart = null;
let lastResponse = null;

const MAX_SAMPLES = 5000;
const MAX_BITS = 16;
const BUCKET_THRESHOLD_BITS = 12;

const el = id => document.getElementById(id);

function showToast(msg, type='info', ms=3000){
  const t = document.createElement('div');
  t.className = 'toast ' + (type==='error' ? 'error' : type==='success' ? 'success' : 'info');
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), ms);
}

/* ========== BACKEND CALLS ========== */
async function generateRandomNumbers(numBits, numSamples){
  const payload = { num_bits: parseInt(numBits,10), num_samples: parseInt(numSamples,10) };
  const res = await fetch(`${API_BASE_URL}/generate`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error(`Server ${res.status}: ${txt}`);
  }
  return res.json();
}

async function fetchHealth(){
  const res = await fetch(`${API_BASE_URL}/health`);
  if(!res.ok) throw new Error(`Health ${res.status}`);
  return res.json();
}

async function fetchExportJson(){
  const res = await fetch(`${API_BASE_URL}/export/json`);
  if(!res.ok){ const t = await res.text().catch(()=>res.statusText); throw new Error(`Export JSON failed ${res.status}: ${t}`); }
  return res.blob();
}

async function fetchExportCsv(){
  const res = await fetch(`${API_BASE_URL}/export/csv`);
  if(!res.ok){ const t = await res.text().catch(()=>res.statusText); throw new Error(`Export CSV failed ${res.status}: ${t}`); }
  return res.blob();
}

/* ========== UI HELPERS ========== */
function formatNumber(number, numBits){
  const n = Number(number);
  const maxValue = Math.pow(2, numBits)-1;
  const width = maxValue.toString().length;
  return String(n).padStart(width,'0');
}

function updateStatistics(statsCandidate = {}){
  // Accept multiple shapes (stats, statistics, top-level)
  const s = statsCandidate ?? {};
  const statsObj = s.statistics ?? s.stats ?? s;

  const mean = Number(statsObj.mean ?? 0);
  const std  = Number(statsObj.std  ?? 0);
  const min  = statsObj.min ?? 0;
  const max  = statsObj.max ?? 0;

  if(el('meanValue')) el('meanValue').textContent = Number.isFinite(mean) ? mean.toFixed(2) : 'â€”';
  if(el('stdValue'))  el('stdValue').textContent  = Number.isFinite(std)  ? std.toFixed(2)  : 'â€”';
  if(el('minValue'))  el('minValue').textContent  = (min !== undefined && min !== null) ? String(min) : 'â€”';
  if(el('maxValue'))  el('maxValue').textContent  = (max !== undefined && max !== null) ? String(max) : 'â€”';
}

function updateMetaFromResponse(data = {}){
  const meta = data.meta ?? {};
  const versionVal = data.version ?? meta.version ?? null;
  const timestampVal = data.timestamp ?? meta.timestamp ?? null;
  const sourceVal = data.source ?? meta.source ?? null;
  const entropyVal = data.entropy ?? meta.entropy ?? data.stats?.entropy ?? data.statistics?.entropy ?? null;

  if(el('metaVersion')) el('metaVersion').textContent = versionVal ? String(versionVal) : 'â€”';
  if(el('metaTime')) el('metaTime').textContent = timestampVal ? String(timestampVal) : 'â€”';
  if(el('entropyValue')) {
    el('entropyValue').textContent = (entropyVal !== null && entropyVal !== undefined) ? (Number(entropyVal).toFixed ? Number(entropyVal).toFixed(4) : String(entropyVal)) : 'â€”';
  }
  if(sourceVal) updateSourceIndicator(sourceVal);
}

function updateSourceIndicator(source){
  const indicator = el('sourceIndicator');
  if(!indicator) return;
  indicator.textContent = source === 'ANU' ? 'ANU Quantum Source' : 'Qiskit Simulator';
  indicator.className = `source-badge ${source === 'ANU' ? 'source-anu' : 'source-simulator'} transition-opacity duration-300`;
  indicator.style.opacity = '1';
}

/* ========== CHARTING & TABLE ========== */
function renderDistributionGraph(numbers=[], numBits){
  const canvas = el('distributionChart');
  if(!canvas) return;
  const bits = parseInt(numBits,10);
  if(isNaN(bits) || bits < 1) return;

  const nums = (numbers||[]).map(x=>Number(x)).filter(x => Number.isFinite(x));
  const maxValue = (1<<bits)-1;
  let labels = [], counts = [];

  if(bits <= BUCKET_THRESHOLD_BITS && maxValue <= 4096){
    counts = new Array(maxValue+1).fill(0);
    nums.forEach(n => { if(n>=0 && n<=maxValue) counts[n]++; });
    labels = counts.map((_,i) => String(i));
  } else {
    const BUCKETS = 256;
    counts = new Array(BUCKETS).fill(0);
    nums.forEach(n => {
      if(n<0 || n>maxValue || !Number.isFinite(n)) return;
      const idx = Math.floor((n/maxValue)*(BUCKETS-1));
      counts[Math.max(0, Math.min(BUCKETS-1, idx))]++;
    });
    labels = counts.map((_,i) => {
      const from = Math.round((i/BUCKETS)*maxValue);
      const to = Math.round(((i+1)/BUCKETS)*maxValue);
      return `${from}â€“${to}`;
    });
  }

  try{ if(distributionChart) distributionChart.destroy(); } catch(e){ console.warn(e); }
  const ctx = canvas.getContext('2d');
  distributionChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets:[{ label:'Frequency', data:counts, backgroundColor:'rgba(99,102,241,0.6)' }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ autoSkip:true, maxTicksLimit:20 } }, y: {} }, plugins:{ legend:{ display:false } }, animation:{ duration:600 } }
  });
}

function renderTable(numbers=[], numBits){
  const tbody = el('tableBody');
  if(!tbody) return;
  tbody.innerHTML = '';
  (numbers || []).forEach((n,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${i+1}</td><td class="p-2">${n}</td><td class="p-2">${Number(n).toString(2).padStart(numBits,'0')}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========== DOWNLOAD & COPY ========== */
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

async function initDownloadJson(){
  const btn = el('downloadJson'); if(!btn) return;
  btn.addEventListener('click', async ()=>{
    try{
      const blob = await fetchExportJson();
      downloadBlob(blob, 'qrng_export.json');
      showToast('JSON downloaded','success');
    } catch(e){ console.error(e); showToast(e.message || 'Export failed','error'); }
  });
}

async function initDownloadCsv(){
  const btn = el('downloadCsv'); if(!btn) return;
  btn.addEventListener('click', async ()=>{
    try{
      const blob = await fetchExportCsv();
      downloadBlob(blob, 'qrng_export.csv');
      showToast('CSV downloaded','success');
    } catch(e){ console.error(e); showToast(e.message || 'Export failed','error'); }
  });
}

function initCopyBtn(){
  const btn = el('copyBtn'); if(!btn) return;
  btn.addEventListener('click', async ()=>{
    if(!lastResponse?.numbers?.length) { showToast('No results to copy','error'); return; }
    try {
      const bits = parseInt(el('numBits')?.value || '8',10);
      const text = lastResponse.numbers.map(n => formatNumber(Number(n), bits)).join('\n');
      await navigator.clipboard.writeText(text);
      showToast('Copied to clipboard','success');
    } catch(e){ console.error(e); showToast('Copy failed','error'); }
  });
}

/* ========== HEALTH / PING ========== */
function initPingBtn(){
  const btn = el('pingBtn'); if(!btn) return;
  btn.addEventListener('click', async ()=>{
    try {
      const info = await fetchHealth();
      showToast(`Server OK â€” ANU: ${info.anu ? 'UP' : 'DOWN'}`, 'success', 2500);
    } catch(e) { console.error(e); showToast('Server not reachable','error',2500); }
  });
}

/* ========== THEME & ACCENT ========== */
function initThemeToggle(){
  const btn = el('themeToggle'); if(!btn) return;
  btn.addEventListener('click', ()=> { document.documentElement.classList.toggle('dark'); });
}

function initAccentPicker(){
  const picker = el('accentPicker'); if(!picker) return;
  picker.addEventListener('change', ev => {
    const color = ev.target.value;
    document.querySelectorAll('.text-blue-300, .text-green-300, .text-purple-300').forEach(node => {
      node.classList.remove('text-blue-300','text-green-300','text-purple-300');
      node.classList.add(`text-${color}-300`);
    });
  });
}

/* ========== SKELETON & GENERATE HANDLER ========== */
function showSkeletons(){
  const rd = el('resultDisplay'); if(rd) rd.innerHTML = '<div class="skeleton h-28 rounded-md"></div>';
  const canvas = el('distributionChart');
  if(canvas){
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(255,255,255,0.03)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  }
}

function initGenerateHandler(){
  const genBtn = el('generateBtn'); if(!genBtn) return;
  genBtn.addEventListener('click', async ()=>{
    const numBitsEl = el('numBits'); const numSamplesEl = el('numSamples');
    if(!numBitsEl || !numSamplesEl) { showToast('Missing inputs','error'); return; }

    let bits = parseInt(numBitsEl.value,10); let samples = parseInt(numSamplesEl.value,10);
    if(isNaN(bits) || isNaN(samples)) { showToast('Enter valid numbers','error'); return; }
    if(bits < 1) bits = 1;
    if(bits > MAX_BITS) { showToast(`numBits max ${MAX_BITS}`,'error'); return; }
    if(samples < 1 || samples > MAX_SAMPLES) { showToast(`samples 1..${MAX_SAMPLES}`,'error'); return; }

    genBtn.disabled = true; const oldHtml = genBtn.innerHTML;
    genBtn.innerHTML = '<span class="flex items-center"><svg class="animate-spin mr-2 h-4 w-4" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/></svg> Quantum Processing...</span>';
    try {
      showSkeletons();
      const data = await generateRandomNumbers(bits, samples);

      // log raw response for debugging
      console.log('QRNG /generate response:', data);

      if(data.status !== 'success') throw new Error(data.message || JSON.stringify(data));

      lastResponse = data;

      // stats may be in data.stats or data.statistics
      const statsCandidate = data.stats ?? data.statistics ?? data;
      updateStatistics(statsCandidate);
      updateMetaFromResponse(data);

      renderTable(data.numbers || [], bits);
      renderDistributionGraph(data.numbers || [], bits);

      // show entropy explicitly if returned
      if(el('entropyValue')){
        const e = data.entropy ?? data.meta?.entropy ?? statsCandidate.entropy ?? null;
        el('entropyValue').textContent = (e !== null && e !== undefined) ? (Number(e).toFixed ? Number(e).toFixed(4) : String(e)) : 'â€”';
      }

      showToast(`Generated ${data.num_samples ?? data.numbers?.length ?? 'N/A'} samples (${data.source ?? 'unknown'})`, 'success', 1800);
    } catch(err) {
      console.error(err);
      showToast(err.message || 'Generation failed', 'error', 3500);
      const r = el('resultDisplay');
      if(r) r.innerHTML = `<div class="text-center py-8 text-red-300">${err.message || 'Generation failed'}</div>`;
    } finally {
      genBtn.disabled = false;
      genBtn.innerHTML = oldHtml;
    }
  });
}

/* ========== INIT ========== */
function initParticles(){
  const container = document.querySelector('.fixed.inset-0.pointer-events-none') || document.querySelector('.fixed.inset-0') || document.body;
  const target = document.querySelector('.fixed.inset-0.pointer-events-none') || document.body;
  for(let i=0;i<12;i++){
    const p = document.createElement('div'); p.className = 'particle';
    p.style.left = `${Math.random()*100}%`; p.style.top = `${Math.random()*100}%`;
    p.style.animationDelay = `${Math.random()*3}s`; p.style.animationDuration = `${2 + Math.random()*2}s`;
    (document.querySelector('.fixed.inset-0.pointer-events-none') || document.body).appendChild(p);
  }
}

function initAll(){
  initGenerateHandler();
  initCopyBtn();
  initDownloadJson();
  initDownloadCsv();
  initPingBtn();
  initThemeToggle();
  initAccentPicker();
  initParticles();
  try { gsap.to('.quantum-pulse', { duration:1.5, repeat:-1, yoyo:true, ease:'power1.inOut' }); } catch(e){}
  // Show onboarding once
  if(!localStorage.getItem('qrngOnboarded')){
    const onboard = el('onboarding'); if(onboard) { onboard.classList.remove('hidden'); setTimeout(()=>onboard.classList.add('hidden'),7000); }
    localStorage.setItem('qrngOnboarded','yes');
  }
  console.log('Frontend initialized (v2.0 UI) â€” API_BASE_URL =', API_BASE_URL);
}

document.addEventListener('DOMContentLoaded', initAll);
  </script>
</body>
</html>
