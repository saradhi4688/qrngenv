<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quantum RNG — Frontend</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: "#6366f1",
              dark: "#4338ca"
            }
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 transition-colors duration-500">
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-slate-800/80 backdrop-blur border-b border-slate-700 shadow-md">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
        ⚛️ <span class="animate-pulse">Quantum RNG</span>
      </h1>
      <div class="flex items-center gap-3">
        <button id="toggleTheme" class="text-sm font-medium text-primary hover:text-primary-dark transition">🌙 Toggle Theme</button>
        <a href="#" id="openInfo" class="text-sm font-medium text-primary hover:text-primary-dark transition">API Info</a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <!-- Backend URL -->
    <section>
      <div class="bg-slate-800 rounded-2xl shadow-lg p-5 border border-slate-700 transition hover:scale-[1.01] duration-200">
        <div class="flex flex-col md:flex-row md:items-end md:gap-4 gap-3">
          <label class="flex-1">
            <span class="block text-sm font-medium text-slate-300">Backend Base URL</span>
            <input id="baseUrl" type="url" class="mt-1 w-full rounded-xl border-slate-600 bg-slate-900 text-slate-100 focus:border-primary focus:ring-primary transition" placeholder="http://localhost:5000" value="http://127.0.0.1:5000" />
          </label>
          <button id="pingBtn" class="inline-flex items-center justify-center rounded-xl bg-primary px-4 py-2.5 font-semibold text-white hover:bg-primary-dark active:scale-[.97] transition">Ping</button>
        </div>
        <p id="pingStatus" class="mt-3 text-sm text-slate-400 hidden"></p>
      </div>
    </section>

    <!-- Controls -->
    <section>
      <div class="bg-slate-800 rounded-2xl shadow-lg p-5 border border-slate-700 transition hover:scale-[1.01] duration-200">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <label>
            <span class="block text-sm font-medium text-slate-300">Bits per number (1–16)</span>
            <input id="numBits" type="number" min="1" max="16" value="8" class="mt-1 w-full rounded-xl border-slate-600 bg-slate-900 text-slate-100 focus:border-primary focus:ring-primary transition" />
          </label>
          <label>
            <span class="block text-sm font-medium text-slate-300">How many samples (1–1000)</span>
            <input id="numSamples" type="number" min="1" max="1000" value="50" class="mt-1 w-full rounded-xl border-slate-600 bg-slate-900 text-slate-100 focus:border-primary focus:ring-primary transition" />
          </label>
          <div class="flex items-end gap-2">
            <button id="genBtn" class="flex-1 rounded-xl bg-primary text-white px-4 py-2.5 font-semibold hover:bg-primary-dark active:scale-[.97] transition">Generate</button>
            <button id="clearBtn" class="rounded-xl border border-slate-600 px-4 py-2.5 font-semibold hover:bg-slate-700 transition">Clear</button>
          </div>
        </div>
        <div id="errorBox" class="mt-4 hidden rounded-xl border border-rose-600 bg-rose-900/40 p-3 text-rose-300 text-sm"></div>
      </div>
    </section>

    <!-- Stats -->
    <section class="space-y-6">
      <div id="statsCard" class="hidden bg-slate-800 rounded-2xl shadow-lg p-5 border border-slate-700">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-lg font-semibold">📊 Statistics</h2>
          <div class="flex gap-2">
            <button id="downloadJson" class="rounded-lg border border-slate-600 px-3 py-1.5 text-sm font-semibold hover:bg-slate-700 transition">Download JSON</button>
            <button id="downloadCsv" class="rounded-lg border border-slate-600 px-3 py-1.5 text-sm font-semibold hover:bg-slate-700 transition">Download CSV</button>
            <button id="copyCurl" class="rounded-lg border border-slate-600 px-3 py-1.5 text-sm font-semibold hover:bg-slate-700 transition">Copy cURL</button>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-900 border border-slate-700"><div class="text-slate-400">Mean</div><div id="statMean" class="text-xl font-bold">—</div></div>
          <div class="p-3 rounded-xl bg-slate-900 border border-slate-700"><div class="text-slate-400">Std Dev</div><div id="statStd" class="text-xl font-bold">—</div></div>
          <div class="p-3 rounded-xl bg-slate-900 border border-slate-700"><div class="text-slate-400">Min</div><div id="statMin" class="text-xl font-bold">—</div></div>
          <div class="p-3 rounded-xl bg-slate-900 border border-slate-700"><div class="text-slate-400">Max</div><div id="statMax" class="text-xl font-bold">—</div></div>
          <div class="p-3 rounded-xl bg-slate-900 border border-slate-700"><div class="text-slate-400">Range</div><div id="statRange" class="text-xl font-bold">—</div></div>
        </div>
      </div>

      <!-- Chart -->
      <div id="chartCard" class="hidden bg-slate-800 rounded-2xl shadow-lg p-5 border border-slate-700">
        <h2 class="text-lg font-semibold mb-4">📈 Distribution</h2>
        <div class="h-64">
          <canvas id="histogram"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div id="tableCard" class="hidden bg-slate-800 rounded-2xl shadow-lg p-5 border border-slate-700">
        <h2 class="text-lg font-semibold mb-3">📋 Generated Numbers</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-400 border-b border-slate-700">
                <th class="py-2 pr-6">#</th>
                <th class="py-2 pr-6">Decimal</th>
                <th class="py-2 pr-6">Binary</th>
              </tr>
            </thead>
            <tbody id="numbersBody" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Info Modal -->
  <dialog id="infoModal" class="rounded-2xl shadow-xl border border-slate-700 backdrop:bg-slate-900/70 p-0 w-[min(580px,92vw)] bg-slate-800 text-slate-100">
    <div class="p-5">
      <div class="flex items-start justify-between gap-4">
        <h3 class="text-lg font-semibold">ℹ️ API Information</h3>
        <button id="closeInfo" class="rounded-lg border border-slate-600 px-2.5 py-1 text-sm hover:bg-slate-700 transition">Close</button>
      </div>
      <pre id="infoContent" class="mt-3 whitespace-pre-wrap text-sm bg-slate-900 border border-slate-700 rounded-xl p-3 overflow-auto max-h-[60vh]"></pre>
    </div>
  </dialog>

  <!-- Script -->
  <script>
    const el = (id) => document.getElementById(id);
    const baseUrlInput = el('baseUrl');
    const errorBox = el('errorBox');
    const statsCard = el('statsCard');
    const chartCard = el('chartCard');
    const tableCard = el('tableCard');
    let lastResponse = null;
    let chart = null;

    function animateCard(card) {
      gsap.fromTo(card, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.6, ease: "power2.out" });
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
      gsap.fromTo(errorBox, { opacity: 0 }, { opacity: 1, duration: 0.3 });
    }
    function hideError() { errorBox.classList.add('hidden'); }

    async function api(path, opts = {}) {
      const base = baseUrlInput.value.trim().replace(/\/$/, '');
      const url = base + path;
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
      if (!res.ok) {
        let detail = '';
        try { const j = await res.json(); detail = j.error || JSON.stringify(j); } catch {}
        throw new Error(`HTTP ${res.status} ${res.statusText}${detail ? ` — ${detail}` : ''}`);
      }
      return res.json();
    }

    function renderStats(stats) {
      el('statMean').textContent = Number(stats.mean).toFixed(3);
      el('statStd').textContent  = Number(stats.std).toFixed(3);
      el('statMin').textContent  = stats.min;
      el('statMax').textContent  = stats.max;
      el('statRange').textContent= stats.range;
      statsCard.classList.remove('hidden');
      animateCard(statsCard);
    }

    function renderTable(numbers, numBits) {
      const tbody = el('numbersBody');
      tbody.innerHTML = '';
      numbers.forEach((n, i) => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-700/40 transition";
        tr.innerHTML = `
          <td class="py-2 pr-6">${i+1}</td>
          <td class="py-2 pr-6 font-medium">${n}</td>
          <td class="py-2 pr-6 font-mono">${Number(n).toString(2).padStart(numBits, '0')}</td>`;
        tbody.appendChild(tr);
      });
      tableCard.classList.remove('hidden');
      animateCard(tableCard);
    }

    function renderHistogram(numbers, maxValue) {
      const labels = Array.from({length: maxValue + 1}, (_, i) => i);
      const counts = new Array(maxValue + 1).fill(0);
      numbers.forEach(n => counts[n]++);
      const ctx = document.getElementById('histogram').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Frequency', data: counts, backgroundColor: '#6366f1' }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 20 } } } }
      });
      chartCard.classList.remove('hidden');
      animateCard(chartCard);
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    el('genBtn').addEventListener('click', async () => {
      hideError();
      const num_bits = Number(el('numBits').value);
      const num_samples = Number(el('numSamples').value);
      if (!(num_bits >= 1 && num_bits <= 16)) return showError('num_bits must be 1–16');
      if (!(num_samples >= 1 && num_samples <= 1000)) return showError('num_samples must be 1–1000');
      try {
        const data = await api('/generate', { method: 'POST', body: JSON.stringify({ num_bits, num_samples }) });
        lastResponse = data;
        renderStats(data.statistics);
        renderTable(data.numbers, data.parameters.num_bits);
        renderHistogram(data.numbers, data.parameters.max_value);
      } catch (e) {
        showError(e.message);
      }
    });

    el('clearBtn').addEventListener('click', () => {
      hideError();
      statsCard.classList.add('hidden');
      chartCard.classList.add('hidden');
      tableCard.classList.add('hidden');
      el('numbersBody').innerHTML = '';
      if (chart) chart.destroy();
      lastResponse = null;
    });

    el('downloadJson').addEventListener('click', () => {
      if (!lastResponse) return;
      download('qrng_response.json', JSON.stringify(lastResponse, null, 2));
    });
    el('downloadCsv').addEventListener('click', () => {
      if (!lastResponse) return;
      const { numbers, parameters } = lastResponse;
      const { num_bits } = parameters;
      const rows = ['index,decimal,binary'];
      numbers.forEach((n, i) => rows.push(`${i+1},${n},${Number(n).toString(2).padStart(num_bits, '0')}`));
      download('qrng_numbers.csv', rows.join('\n'));
    });

    el('copyCurl').addEventListener('click', () => {
      const base = baseUrlInput.value.trim().replace(/\/$/, '');
      const num_bits = Number(el('numBits').value);
      const num_samples = Number(el('numSamples').value);
      const curl = `curl -s -X POST \\
  -H "Content-Type: application/json" \\
  -d '{"num_bits": ${num_bits}, "num_samples": ${num_samples}}' \\
  "${base}/generate"`;
      navigator.clipboard.writeText(curl).then(() => {
        const btn = el('copyCurl');
        const old = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = old), 1000);
      });
    });

    el('pingBtn').addEventListener('click', async () => {
      hideError();
      const indicator = el('pingStatus');
      indicator.classList.remove('hidden');
      indicator.textContent = 'Pinging…';
      try {
        const j = await api('/');
        indicator.textContent = `Connected ✓ — ${j.message || 'OK'}`;
      } catch (e) {
        indicator.textContent = 'Failed ✗ — ' + e.message;
      }
    });

    el('openInfo').addEventListener('click', async (e) => {
      e.preventDefault();
      try { const j = await api('/info'); el('infoContent').textContent = JSON.stringify(j, null, 2); }
      catch (err) { el('infoContent').textContent = 'Error loading /info: ' + err.message; }
      el('infoModal').showModal();
      gsap.fromTo("#infoModal", { opacity: 0, scale: 0.9 }, { opacity: 1, scale: 1, duration: 0.4, ease: "power2.out" });
    });
    el('closeInfo').addEventListener('click', () => el('infoModal').close());

    el('toggleTheme').addEventListener('click', () => {
      document.documentElement.classList.toggle("dark");
      document.body.classList.toggle("bg-slate-50");
      document.body.classList.toggle("text-slate-800");
    });
  </script>
</body>
</html>
